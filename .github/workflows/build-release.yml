name: Build and Release LuiseStore

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release
      - develop
    tags:
      - 'v*.*.*'

env:
  THEOS: ${{ github.workspace }}/theos
  THEOS_PACKAGE_SCHEME: rootless
  FINALPACKAGE: 1

jobs:
  build:
    name: Build LuiseStore
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/dpkg
            /opt/homebrew/Cellar/ldid-procursus
            /opt/homebrew/Cellar/make
            /opt/homebrew/Cellar/openssl@3
            /opt/homebrew/Cellar/libarchive
          key: ${{ runner.os }}-homebrew-${{ hashFiles('.github/workflows/build-release.yml') }}-dpkg-ldid-procursus-make-openssl3-libarchive
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Install system dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          # Update PATH to use GNU make instead of BSD make
          echo "/opt/homebrew/opt/make/libexec/gnubin" >> $GITHUB_PATH

          # Install required packages via Homebrew
          brew install dpkg ldid-procursus make openssl@3 libarchive

      - name: Cache THEOS framework
        id: cache-theos
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/theos
          key: ${{ runner.os }}-theos-${{ hashFiles('.github/workflows/build-release.yml') }}-master
          restore-keys: |
            ${{ runner.os }}-theos-

      - name: Checkout THEOS framework
        if: steps.cache-theos.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Install iOS SDKs
        uses: actions/checkout@v4
        with:
          repository: theos/sdks
          path: theos/sdks
          sparse-checkout: |
            iPhoneOS14.5.sdk
            iPhoneOS16.5.sdk

      - name: Build LuiseStore
        timeout-minutes: 45
        run: |
          make ci-build

      - name: Create artifacts staging directory
        run: |
          mkdir -p artifacts

      - name: Collect build outputs from _build directory
        run: |
          # Collect tar and ipa files from _build directory
          if [ -d "_build" ]; then
            echo "Collecting artifacts from _build directory..."
            find _build -type f \( -name "*.tar" -o -name "*.ipa" \) -exec cp -v {} artifacts/ \;
          else
            echo "Warning: _build directory not found"
          fi

      - name: Collect deb packages
        run: |
          # Find and collect all deb packages from .theos/packages and packages directories
          echo "Collecting deb packages..."
          find . -type f -name "*.deb" \( -path "*/.theos/packages/*" -o -path "*/packages/*" \) -exec cp -v {} artifacts/ \;
          
          # List what we found
          echo "Deb packages found:"
          find . -type f -name "*.deb" \( -path "*/.theos/packages/*" -o -path "*/packages/*" \)

      - name: List collected artifacts
        run: |
          echo "Collected artifacts:"
          ls -lh artifacts/
          echo ""
          echo "Total artifacts: $(ls -1 artifacts/ | wc -l)"

      - name: Extract version information
        id: version
        run: |
          # Try to extract version from git tag first
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag (remove 'refs/tags/v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "Version extracted from git tag: $VERSION"
          else
            # Fallback: Extract version from Info.plist
            PLIST_PATH="TrollStore/Resources/Info.plist"
            if [ -f "$PLIST_PATH" ]; then
              # Use PlistBuddy to read CFBundleVersion
              VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH" 2>/dev/null || echo "")
              
              # If CFBundleVersion is empty or not found, try CFBundleShortVersionString
              if [ -z "$VERSION" ]; then
                VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH" 2>/dev/null || echo "unknown")
              fi
              
              echo "Version extracted from Info.plist: $VERSION"
            else
              echo "Warning: Info.plist not found, using 'unknown' as version"
              VERSION="unknown"
            fi
          fi
          
          # Store version in environment variable for later steps
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Also output as step output for conditional use
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "Final version: $VERSION"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luisestore-build-${{ env.VERSION }}-${{ github.sha }}
          path: artifacts/
          retention-days: 90
          if-no-files-found: error

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-build-artifacts-${{ github.sha }}
          path: |
            _build/
            **/.theos/obj/
            **/.theos/packages/
            artifacts/
          retention-days: 30
          if-no-files-found: warn

      - name: Create GitHub Release
        if: |
          success() && (
            github.ref == 'refs/heads/main' ||
            github.ref == 'refs/heads/release' ||
            startsWith(github.ref, 'refs/tags/v')
          )
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('v{0}', env.VERSION) }}
          name: LuiseStore v${{ env.VERSION }}
          body: |
            ## LuiseStore v${{ env.VERSION }}
            
            Automated build from commit ${{ github.sha }}
            
            ### Build Information
            - **Branch/Tag**: ${{ github.ref_name }}
            - **Commit**: ${{ github.sha }}
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            
            ### Artifacts
            This release includes the following build artifacts:
            - LuiseStore.tar - Main LuiseStore package
            - LuiseHelper and LuiseStoreLite deb packages
            
            Note: Installer IPAs are not included in automated builds as they require a victim IPA.
            
            ### Installation
            Please refer to the [LuiseStore documentation](https://github.com/luisepog/LuiseStore) for installation instructions.
          draft: false
          prerelease: ${{ contains(env.VERSION, '-beta') || contains(env.VERSION, '-rc') || contains(env.VERSION, '-alpha') }}
          files: |
            artifacts/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
